# BADWALL - Telegram бот для модерации чата

Telegram бот на aiogram для автоматической проверки сообщений на наличие нецензурной лексики с помощью библиотеки [check-swear](https://github.com/bbd03/check-swear).

## Возможности

- ✅ Автоматическая проверка всех сообщений в групповых чатах на мат
- ✅ Удаление сообщений с вероятностью мата ≥ 0.7 (только в группах)
- ✅ Использование ML-модели (SVM) для определения контекста
- ✅ Поддержка русского языка и транслитерации
- ✅ Ежедневная статистика работы бота (отправляется админам в личные сообщения в 21:00)
- ✅ Работа только в указанных групповых чатах (безопасность)
- ✅ Команды бота работают только в личных сообщениях

## Установка

1. Клонируйте репозиторий или скачайте файлы

2. Установите зависимости:
```bash
pip install -r requirements.txt
```

3. Создайте файл `.env` в корне проекта

5. Получите chat_id чата, где будет работать бот:
   - Добавьте бота в группу
   - Отправьте любое сообщение в группу
   - Перейдите по ссылке: `https://api.telegram.org/bot<ВАШ_ТОКЕН>/getUpdates`
   - Найдите `"chat":{"id":-123456789}` - это и есть chat_id (может быть отрицательным для групп)
   - Или используйте бота [@userinfobot](https://t.me/userinfobot) - добавьте его в группу и он покажет chat_id

6. Настройте `.env` файл:
```
BOT_TOKEN=your_bot_token_here
PROFANITY_THRESHOLD=0.7
ALLOWED_CHAT_IDS=-123456789,-987654321
ADMIN_IDS=123456789,987654321
```
   - `BOT_TOKEN` - токен бота от BotFather
   - `PROFANITY_THRESHOLD` - порог вероятности мата (рекомендуется 0.7)
   - `ALLOWED_CHAT_IDS` - список chat_id разрешенных чатов через запятую (без пробелов)
   - `ADMIN_IDS` - список user_id админов для получения статистики через запятую (без пробелов)

## Настройка бота в группе

Для корректной работы бота необходимо:

1. Добавить бота в группу как администратора
2. Выдать боту права на удаление сообщений:
   - Откройте настройки группы
   - Перейдите в "Администраторы"
   - Выберите бота
   - Включите право "Удалять сообщения"

## Запуск

### Обычный запуск

```bash
python bot.py
```

### Запуск в Docker

1. Убедитесь, что у вас установлены Docker и Docker Compose

2. Соберите образ:
```bash
docker-compose build
```

3. Запустите контейнер:
```bash
docker-compose up -d
```

4. Просмотр логов:
```bash
docker-compose logs -f
```

5. Остановка:
```bash
docker-compose down
```

**Примечание:** 
- Убедитесь, что файл `.env` находится в корне проекта и содержит все необходимые переменные
- Docker Compose автоматически загружает переменные из `.env` файла
- Контейнер автоматически перезапускается при сбое (`restart: unless-stopped`)

## Структура проекта

```
BADWALL/
├── bot.py                      # Основной файл запуска бота
├── config.py                   # Конфигурация (токен, пороги, админы)
├── requirements.txt            # Зависимости проекта
├── .env                        # Переменные окружения (создать самостоятельно)
├── Dockerfile                  # Docker образ
├── docker-compose.yml          # Docker Compose конфигурация
├── .dockerignore               # Исключения для Docker
├── handlers/                   # Обработчики сообщений
│   ├── __init__.py
│   └── common.py               # Обработчики команд
├── middlewares/                # Middleware
│   ├── __init__.py
│   └── profanity_middleware.py # Middleware для проверки на мат
└── utils/                      # Утилиты
    ├── __init__.py
    └── statistics.py           # Класс для сбора статистики
```

## Настройка порога

Порог вероятности мата для удаления сообщения настраивается в файле `.env`:

```
PROFANITY_THRESHOLD=0.7
```

- **0.7** (по умолчанию) - средний уровень строгости
- **0.5** - более строгая модерация
- **0.9** - более мягкая модерация

## Статистика

Бот автоматически собирает статистику своей работы:
- Количество проверенных сообщений
- Количество удаленных сообщений
- Процент удалений
- Статистика по каждому чату (если бот работает в нескольких чатах)

Статистика отправляется всем админам (указанным в `ADMIN_IDS`) **ежедневно в 21:00** по московскому времени **в личные сообщения**. После отправки статистика автоматически сбрасывается.

### Как получить свой user_id для ADMIN_IDS

1. Напишите боту [@userinfobot](https://t.me/userinfobot) в личные сообщения
2. Бот пришлет ваш user_id (это число, например: `123456789`)
3. Добавьте его в `ADMIN_IDS` в файле `.env`

## Безопасность

**Модерация** работает **только** в групповых чатах, указанных в `ALLOWED_CHAT_IDS`. Сообщения из других групп полностью игнорируются. Это гарантирует, что бот не будет модерировать чужие группы без вашего разрешения.

**Команды** бота (например, `/start`) работают **только** в личных сообщениях. Бот не отвечает на команды в групповых чатах, чтобы не засорять чат.

## Примечания

- **Модерация** работает **только** в групповых чатах, указанных в `ALLOWED_CHAT_IDS`
- **Команды** бота работают **только** в личных сообщениях (бот не отвечает в группах)
- Бот должен быть администратором группы с правами на удаление сообщений
- Для удаления сообщений бот должен иметь соответствующие права
- Библиотека check-swear использует ML-модель, обученную на 700,000+ комментариев
- Модель может иметь ложные срабатывания, особенно на необычные слова
- Чтобы добавить новый чат для модерации, добавьте его chat_id в `ALLOWED_CHAT_IDS` через запятую и перезапустите бота
- Статистика отправляется автоматически в 21:00 ежедневно всем админам из `ADMIN_IDS` в личные сообщения
- После отправки статистики она автоматически сбрасывается и начинается новый день

## Лицензия

MIT

